##### 一、变量提升

1. 普通变量提升

   ```js
   console.log(a); // undefined
   var a = 10;
   ```

2. 函数提升

   ```js
   console.log(a); // [λ: a]
   function a() {}
   var a = 10;
   ```

3. 特殊场景

   ```js
   console.log(a); // undefined
   var a = function () {};
   var a = 10;

   function f(a, b) {
     console.log(a); // [λ: a]
     var a = 'a';
     console.log(a); // a
     function a() {}
   }
   f(1);
   ```

4. 总结
   - 变量声明和函数声明在预编译阶段都会被提升到作用域的最顶端，函数提升的优先级高于变量提升
   - 变量提升只提升声明，不提升赋值
   - 函数提升会将函数体一起提升
   - 如果存在同样名称的变量声明和函数声明，变量声明会被忽略

---

###### 二、执行上下文

1. 执行上下文生命周期
   - 编译阶段
     - 创建变量对象
     - 创建作用域链
     - 确定 this 指向
   - 执行阶段
      - 变量赋值
      - 函数引用
      - 执行其他代码

2. javascript 是静态作用域，在函数定义时就确定了作用域

3. 函数创建和执行过程解析

    ```js
    var str = 'global value'
    function fn() {
      var str2 = 'local value'
      return str2
    }
    fn()

    // 1. 函数 fn 被创建，保存作用域链到内部属性 [[scope]]
    ECStack = {
      GlobalContext
    }
    fn.[[scope]] = {
      GlobalContext: VO
    }
    // 2. 执行 fn 函数，创建函数执行上下文，并将函数执行上下文压入栈顶
    ECStack = {
      fnContext,
      GlobalContext
    }
    // 3. 复制函数 [[scope]] 属性创建作用域链
    fnContext = {
      Scope: fn.[[scope]]
    }
    // 4. 创建 AO，创建 arguments 对象，创建函数声明和变量声明
    fnContext = {
      AO: {
        arguments: {
          length: 0
        },
        str2: undefined
      },
      Scope: [Scope]
    }
    // 5. 将活动对象 AO 压入作用域链
    fnContext = {
      AO: {
        arguments: {
          length: 0
        },
        str2: undefined
      },
      Scope: [AO, Scope]
    }
    // 6. 执行函数，str2 赋值
    fnContext = {
      AO: {
        arguments: {
          length: 0
        },
        str2: 'local value'
      },
      Scope: [AO, Scope]
    }
    // 7. 函数执行完，将函数执行上下文弹出
    ECStack = {
      GlobalContext
    }
    ```

4. 分解执行上下文过程

    ```js
    let a = 20;
    const b = 30;
    var c;
    function multiply(e, f) {
        var g = 20;
        return e * f * g;
    }
    c = multiply(20, 30);

    // 伪代码示例
    // 1. 全局执行上下文
    GlobalExecutionContext = {
      ThisBinding: <GLobal Object>,
      LexicalEnvironment: { // 词法环境
        EnvironmentRecord: {
          Type: 'Object',
          a: <uninitialized>,
          b: <uninitialized>,
          multiply: <func>
        },
        outer: null
      },
      VariableEnvironment: { // 变量环境
        EnvironmentRecord: {
          Type: 'Object',
          c: undefined
        },
        outer: null
      }
    }
    // 2. 函数执行上下文
    FunctionExecutionContext = {
      ThisBinding: <GLobal Object>,
      LexicalEnvironment: {
        EnvironmentRecord: {
          Type: 'Declarative',
          Arguments: {
            0: 20,
            1: 30,
            length: 2
          }
        },
        outer: <GlobalLexicalEnvironment>
      },
      VariableEnvironment: {
        EnvironmentRecord: {
          Type: 'Declarative',
          g: undefined
        },
        outer: <GlobalLexicalEnvironment>
      }
    }
    ```
